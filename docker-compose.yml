# Docker Compose pour développement local
# Usage: docker-compose up -d
# Arrêter: docker-compose down

services:
  postgres:
    image: postgres:15-alpine
    container_name: tirallarc-db-dev
    environment:
      POSTGRES_DB: terrain_tir_arc
      POSTGRES_USER: tir_arc_user
      POSTGRES_PASSWORD: dev_password_123
    ports:
      - "5432:5432"  # Exposé pour connexion locale (psql, pgAdmin)
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tir_arc_user -d terrain_tir_arc"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tirallarc-network-dev

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tirallarc-app-dev
    ports:
      - "3000:3000"  # Backend API + Frontend
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: terrain_tir_arc
      DB_USER: tir_arc_user
      DB_PASSWORD: dev_password_123
      # Secrets pour développement (NE PAS UTILISER EN PRODUCTION!)
      JWT_SECRET: dev_jwt_secret_1234567890123456789012345678901234567890
      JWT_REFRESH_SECRET: dev_jwt_refresh_secret_1234567890123456789012345678901234567890
      SESSION_SECRET: dev_session_secret_1234567890123456789012345678901234567890
      ENCRYPTION_KEY: a2a760db2e9ce9941b94c738e0fcbefed3c1643456dd67299a0969a211611b75
      # Configuration application
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost
      LOG_LEVEL: debug
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 1000  # Plus permissif en dev
      BCRYPT_ROUNDS: 10  # Plus rapide en dev
      # Email (optionnel en dev)
      SMTP_HOST:
      SMTP_PORT:
      SMTP_SECURE:
      SMTP_USER:
      SMTP_PASSWORD:
    volumes:
      # Volumes pour persister les données
      - app_uploads_dev:/app/uploads
      - app_logs_dev:/app/logs
      # Hot reload (optionnel - décommenter pour dev avec nodemon)
      # - ./server:/app/server:ro
      # - ./public:/app/public:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tirallarc-network-dev
    restart: unless-stopped

volumes:
  postgres_data_dev:
    driver: local
  app_uploads_dev:
    driver: local
  app_logs_dev:
    driver: local

networks:
  tirallarc-network-dev:
    driver: bridge
