<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signaler un Incident - Terrain Tir Arc</title>
<link rel="icon" type="image/png" href="images/icon-192.png">
<link rel="apple-touch-icon" href="images/icon-192.png">
<link rel="stylesheet" href="css/style.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2E7D32">
<style>
/* Adaptations mobiles pour incident.html */
@media (max-width: 768px) {
/* R√©duction de la taille des caract√®res de 10% (90% de la taille normale) */
body, .container {
font-size: 90% !important;
}
/* Interlignes normales (100% - pas de r√©duction) */
body, .container, p, div, label, input, textarea, select, button {
line-height: normal !important;
}
/* Titres - 10% plus petits */
h1 {
font-size: 1.8rem !important; /* 90% de 2rem */
}
h2 {
font-size: 1.62rem !important; /* 90% de 1.8rem */
}
h3 {
font-size: 1.44rem !important; /* 90% de 1.6rem */
}
/* Header */
.header h1 {
font-size: 1.62rem !important; /* 90% */
}
.header p {
font-size: 0.99rem !important; /* 90% de 1.1rem */
}
/* Formulaire */
.form-card h2 {
font-size: 1.62rem !important; /* 90% */
}
.form-description {
font-size: 0.9rem !important; /* 90% de 1rem */
}
.form-group label {
font-size: 0.9rem !important; /* 90% de 1rem */
}
.form-control {
font-size: 0.9rem !important; /* 90% */
padding: 8px !important;
}
.form-text, small {
font-size: 0.72rem !important; /* 90% de 0.8rem */
}
/* Boutons */
.btn {
font-size: 0.9rem !important; /* 90% de 1rem */
padding: 10px 16px !important;
}
/* Footer */
.footer {
font-size: 0.72rem !important; /* 90% de 0.8rem */
}
/* Alert messages */
.alert {
font-size: 0.9rem !important; /* 90% */
}
}
</style>
</head>
<body>
<div class="container">
<header class="header">
<div class="logo">
<h1>üéØ Signaler un Incident</h1>
<p>Terrain de Tir √† l'Arc</p>
</div>
<div class="header-actions">
<button id="backBtn" class="btn btn-secondary">
‚Üê Retour
</button>
</div>
</header>
<main class="main-content">
<div class="form-card">
<h2>üì¢ Formulaire de Signalement</h2>
<p class="form-description">
Signalez tout incident ou probl√®me rencontr√© sur les terrains.
Votre signalement sera transmis imm√©diatement au responsable.
</p>
<form id="incidentForm" enctype="multipart/form-data">
<div class="form-group">
<label for="typeIncident">Type d'incident *</label>
<select id="typeIncident" name="type_incident" class="form-control" required>
<option value="">S√©lectionnez le type</option>
<option value="√âquipement endommag√©">√âquipement endommag√©</option>
<option value="Accident">Accident</option>
<option value="Comportement dangereux">Comportement dangereux</option>
<option value="Probl√®me mat√©riel">Probl√®me mat√©riel</option>
<option value="Infrastructure">Infrastructure (terrain, √©clairage...)</option>
<option value="Autre">Autre</option>
</select>
</div>

<div class="form-group">
<label for="terrain">Terrain concern√© *</label>
<select id="terrain" name="terrain" class="form-control" required>
<option value="">S√©lectionnez le terrain</option>
<option value="interieur">üèüÔ∏è Terrain Int√©rieur</option>
<option value="exterieur">üå≥ Terrain Ext√©rieur</option>
</select>
</div>

<div class="form-group">
<label for="description">Description d√©taill√©e *</label>
<textarea id="description" name="description" class="form-control"
rows="6" placeholder="D√©crivez l'incident en d√©tail..." required></textarea>
<small class="form-text">Soyez aussi pr√©cis que possible (lieu exact, circonstances, personnes impliqu√©es...)</small>
</div>

<div class="form-group">
<label for="photo">Photo (optionnel)</label>
<input type="file" id="photo" name="photo" class="form-control"
accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
<small class="form-text">Formats accept√©s: JPG, PNG, GIF, WebP (max 10 MB)</small>
</div>

<div class="form-actions">
<button type="submit" class="btn btn-primary">
üì¢ Signaler l'Incident
</button>
<button type="button" id="cancelBtn" class="btn btn-secondary">
Annuler
</button>
</div>
</form>

<div id="formMessage" class="alert hidden"></div>
</div>
</main>
<footer class="footer">
<p>&copy; 2025 Club Istres Sports Tir √† l'Arc</p>
</footer>
</div>
<!-- Logger doit √™tre charg√© en premier pour √™tre disponible dans tous les autres scripts -->
<script src="js/logger.js"></script>
<script src="js/error-handler.js"></script>
<script src="js/validators.js"></script>
<script src="js/database.js"></script>
<script>
// Script pour la page incident
async function init() {
// Event listeners
document.getElementById('backBtn').addEventListener('click', () => {
window.location.href = 'declaration.html';
});

document.getElementById('cancelBtn').addEventListener('click', () => {
if (confirm('Voulez-vous vraiment annuler ?')) {
window.location.href = 'declaration.html';
}
});

document.getElementById('incidentForm').addEventListener('submit', handleSubmit);
}

async function handleSubmit(e) {
e.preventDefault();
const submitBtn = e.target.querySelector('button[type="submit"]');
const originalText = submitBtn.textContent;
submitBtn.disabled = true;
submitBtn.textContent = 'üì§ Envoi en cours...';
try {
const formData = new FormData(e.target);

// Tenter d'envoyer via l'API
if (DatabaseManager.useAPI) {
// Utiliser /api car Nginx fait le proxy vers le backend
const response = await fetch('/api/incidents/upload', {
method: 'POST',
body: formData
});
if (!response.ok) {
const error = await response.json();
throw new Error(error.error || 'Erreur serveur');
}
const data = await response.json();
showMessage('success', '‚úÖ Incident signal√© avec succ√®s ! Le responsable a √©t√© notifi√©.');
e.target.reset();

} else {
// Fallback localStorage (sans photo)
const incident = {
type_incident: formData.get('type_incident'),
description: formData.get('description'),
terrain: formData.get('terrain'),
photo_path: formData.get('photo')?.name || null
};
await DatabaseManager.createIncident(incident);
showMessage('success', '‚úÖ Incident signal√© (mode hors ligne). Synchronisation √† la reconnexion.');
e.target.reset();
}

// Retour apr√®s 2 secondes
setTimeout(() => {
window.location.href = 'declaration.html';
}, 2000);

} catch (error) {
console.error('Erreur signalement incident:', error);
showMessage('error', `‚ùå Erreur: ${error.message}`);
} finally {
submitBtn.disabled = false;
submitBtn.textContent = originalText;
}
}

function showMessage(type, message) {
const messageDiv = document.getElementById('formMessage');
messageDiv.textContent = message;
messageDiv.className = `alert ${type === 'success' ? 'alert-success' : 'alert-danger'}`;
messageDiv.classList.remove('hidden');
window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Initialiser au chargement
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>